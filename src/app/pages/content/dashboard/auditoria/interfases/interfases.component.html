<ngx-spinner bdColor="rgba(0,0,0,0.5)" size="default" color="#fff" type="ball-scale-ripple" [fullScreen]="true">
    <p style="color: white"> Cargando... </p>
</ngx-spinner>
<div class="container-fluid d-flex col-8 align-items-center selector-reporte" style="height: 40px">
    <button id="left-button" [ngClass]="botonActivado('INTERFACES') ? 'botonActivadoInterfases' : ''"
        (click)="setPantalla('INTERFACES')">
        Interfaces
    </button>
    <button id="right-button" [ngClass]="botonActivado('PROBLEMAS') ? 'botonActivadoInterfases' : ''"
        (click)="setPantalla('PROBLEMAS')">
        Problemas Identificados
    </button>
</div>
<!-- ************************************** -->
<!-- ************************************** -->
<!-- **********  F I L T R O S ************ -->
<!-- ************************************** -->
<!-- ************************************** -->
<div class="card-busqueda" [formGroup]="filtroForm">
    <div class="container">
        <div class="row">
            <div class="col-4 titulo-filtro"></div>
            <div class="col-4 justify-content-center titulo-filtro">
                Filtrar por
            </div>
            <div class="col-4 justify-content-center">
                <a class="limpiarFiltro" (click)="limpiarFiltro('')">
                    <img src="assets/icons/icono-eliminar.svg" class="tamanioFiltroIcono" />Eliminar Filtro
                </a>
            </div>
        </div>
    </div>
    <div class="container" *ngIf="botonActivado('PROBLEMAS')">        
            <div class="row">
            <div class="col-4 justify-content-center">
                <ng-multiselect-dropdown style="width: 100%; padding-left: 10px" [placeholder]="'Tipo'" id="filtroTipo"
                    [settings]="SettingsFiltroDeTipo" [data]="dropdownListFiltroTipo"
                    [(ngModel)]="selectedItemsFiltroTipo" [ngModelOptions]="{standalone: true}"
                    (onSelect)="cambiarEtiquetaSeleccionadaGeneral('filtroTipo')">
                </ng-multiselect-dropdown>
            </div>
            <div class="col-4 justify-content-center">
                <ng-multiselect-dropdown style="width: 100%; padding-left: 10px" [placeholder]="'Negocio'"
                    id="filtroNegocio" [settings]="SettingsFiltroDeNegocio" [data]="dropdownListFiltroNegocio"
                    [(ngModel)]="selectedItemsFiltroNegocio" [ngModelOptions]="{standalone: true}"
                    (onSelect)="cambiarEtiquetaSeleccionadaGeneral('filtroNegocio')">
                </ng-multiselect-dropdown>
            </div>
            <div class="col-4 justify-content-center">
                <ng-multiselect-dropdown style="width: 100%; padding-left: 10px" [placeholder]="'Proceso'"
                    id="filtroProceso" [settings]="SettingsFiltroDeProceso" [data]="dropdownListFiltroProceso"
                    [(ngModel)]="selectedItemsFiltroProceso" [ngModelOptions]="{standalone: true}"
                    (onSelect)="cambiarEtiquetaSeleccionadaGeneral('filtroProceso')">
                </ng-multiselect-dropdown>
            </div>
        </div>    
    </div>
    <div class="container">
        <div class="row">
            <div class="col-4 justify-content-center">
                <div class="input-group-text texto">
                    <i class="far fa-question-circle" (mouseenter)="helperQuestions('DEL')"
                        triggers="mouseenter:mouseleave" [ngbPopover]="popContent"></i>
                    &nbsp; Del: &nbsp;
                </div>
                <input style="width: 90%; padding-left: 10px" type="date" placeholder="dd-MM-yyyy"
                    onfocus="(this.type='date')" id="filtroFechaInicio" formControlName="filtroFechaInicio"
                    name="filtroFechaInicio" [value]="maxDate" max="{{ maxDate| date:'yyyy-MM-dd'}}" />
            </div>
            <div class="col-4 justify-content-center">
                <div class="input-group-text texto">
                    <i class="far fa-question-circle" (mouseenter)="helperQuestions('AL')"
                        triggers="mouseenter:mouseleave" [ngbPopover]="popContent"></i>
                    &nbsp; Al: &nbsp;
                </div>
                <input style="width: 90%; padding-left: 10px" type="date" placeholder="dd-MM-yyyy"
                    onfocus="(this.type='date')" id="filtroFechaFin" formControlName="filtroFechaFin"
                    name="filtroFechaFin" [value]="maxDate" max="{{ maxDate| date:'yyyy-MM-dd'}}" />
            </div>
            <div class="col-4 justify-content-center">
                <button style="cursor: pointer" (click)="aplicarFiltro()">Filtrar</button>
            </div>
        </div>
    </div>
</div>

<section name="interfases" *ngIf="botonActivado('INTERFACES')">

    <!-- ************************************** -->
    <!-- ************************************** -->
    <!-- **********  R E S U M E N ************ -->
    <!-- ************************************** -->
    <!-- ************************************** -->
    <div class="d-flex col-md-12 col-sm-12 col-xs-12 col-lg-12 col-xl-12 justify-content-center">
        <div class="row justify-content-center" *ngIf="flagDatos">
            <div class=" align-self-center">
                <div class="d-flex flex-column" style="width: 504px;">
                    <div class="descripcionNoAuditoria" style="margin-top:34px">
                        <div class="row">
                            <div class="col-12">
                                <p> No existen registros para esta búsqueda.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-busqueda" *ngIf="!flagDatos">
        <div class="row col-12 alert alert-primary justify-content-center">
            Resumen de las ejecuciones {{expresion}} &nbsp;
            <i class="far fa-question-circle" (mouseenter)="helperQuestions('RESUMEN')" triggers="mouseenter:mouseleave"
                [ngbPopover]="popContent"></i>
        </div>
        <div class="row col-12 justify-content-center">
            <ng-container *ngFor="let item of treemapPath; let last = last;">
                <a style="cursor: pointer" [class.active]="last" [disabled]="last" (click)="treemapSelect(item)">
                    {{item.name}} ({{item.value}}) </a>
                <span *ngIf="!last"> &nbsp;/&nbsp; </span>
            </ng-container>
            <div class="w-100"></div>
            <div class="maxLeng">
                <ngx-charts-tree-map *ngIf="treeMapNotEmpty" [results]="treemap" [animations]="animations" scheme="air"
                    (select)="treemapSelect($event)">
                    <ng-template #tooltipTemplate let-model="model">
                        <h4>{{model.name}}: {{model.value}}</h4>
                    </ng-template>
                </ngx-charts-tree-map>
            </div>
        </div>
    </div>

    <!-- ************************************** -->
    <!-- ************************************** -->
    <!-- **********  D I U R N O S ************ -->
    <!-- ************************************** -->
    <!-- ************************************** -->
    <div class="card-busqueda" *ngIf="datosDiurno">
        <div class="row col-12 alert alert-primary justify-content-center">
            <div class="row">
                <div class="col-4 titulo-filtro"></div>
                <div class="col-4 titulo-filtro justify-content-center">Diurnos &nbsp;
                    <i class="far fa-question-circle" (mouseenter)="helperQuestions('DIURNOS')"
                        triggers="mouseenter:mouseleave" [ngbPopover]="popContent"></i>
                </div>
                <div class="col-4 titulo-filtro justify-content-end">
                    <a (click)="accionMinimizarDiurno()">
                        <img src="assets/icons/arrows-angle-contract.svg" class="tamanioIcono"
                            *ngIf="flagMinimizarDiurno == true" />
                        <img src="assets/icons/arrows-angle-expand.svg" class="tamanioIcono"
                            *ngIf="flagMinimizarDiurno == false" />
                    </a>
                </div>
            </div>
        </div>
        <div class="row col-12" *ngIf="flagMinimizarDiurno">
            <div class="row col-12">
                <div class="mh-25 d-inline-block col-sm-6 col-md-5 col-lg-6 justify-content-center">
                    <ngx-charts-bar-horizontal scheme="air" [results]="datosAforeFondos" [xAxis]="showXAxis"
                        [yAxis]="showYAxis" [legend]="showLegend" [legendTitle]="legendTitle"
                        [legendPosition]="legendPosition" [showXAxisLabel]="showXAxisLabel"
                        [showYAxisLabel]="showYAxisLabel" [xAxisLabel]="xAxisLabel" [showDataLabel]="showDataLabel"
                        [yAxisLabel]="yAxisLabelNegocio">
                    </ngx-charts-bar-horizontal>
                </div>
                <div
                    class="mh-25 d-inline-block col-sm-6 col-md-5 offset-md-2 col-lg-6 offset-lg-0 justify-content-center">
                    <ngx-charts-bar-horizontal scheme="air" [results]="datosLanzamiento" [xAxis]="showXAxis"
                        [yAxis]="showYAxis" [legend]="showLegend" [legendTitle]="legendTitle"
                        [legendPosition]="legendPosition" [showXAxisLabel]="showXAxisLabel"
                        [showYAxisLabel]="showYAxisLabel" [xAxisLabel]="xAxisLabel" [showDataLabel]="showDataLabel"
                        [yAxisLabel]="yAxisLabel">
                    </ngx-charts-bar-horizontal>
                </div>
                <div class="w-100"></div>
                <div class="col-sm-6 col-md-5 col-lg-6 justify-content-center">
                    <h4>
                        <span class="badge badge-pill badge-primary">AFORE &nbsp;
                            <i class="far fa-question-circle" (mouseenter)="helperQuestions('DETALLE')"
                                triggers="mouseenter:mouseleave" [ngbPopover]="popContent"></i>
                        </span>
                    </h4>
                </div>
                <div class="col-sm-6 col-md-5 offset-md-2 col-lg-6 offset-lg-0 justify-content-center">
                    <h4>
                        <span class="badge badge-pill badge-primary">FONDOS &nbsp;
                            <i class="far fa-question-circle" (mouseenter)="helperQuestions('DETALLE')"
                                triggers="mouseenter:mouseleave" [ngbPopover]="popContent"></i>
                        </span>
                    </h4>
                </div>
                <div class="w-100"></div>
                <div class="col-sm-6 col-md-5 col-lg-6 justify-content-center">
                    <ngx-charts-pie-chart [explodeSlices]="explodeSlices" [scheme]="colorScheme"
                        [results]="datosDiurnoAfore" [labels]="showLabels" [labelFormatting]="setLabelFormatting"
                        [legend]="showLegend" [legendPosition]="legendPosition" [legendTitle]="legendTitle"
                        (select)="mostrarDetalleEjecuciones($event, 'diurnos', 'afore')">
                    </ngx-charts-pie-chart>
                </div>
                <div class="col-sm-6 col-md-5 offset-md-2 col-lg-6 offset-lg-0 justify-content-center">
                    <ngx-charts-pie-chart [explodeSlices]="explodeSlices" [scheme]="colorScheme"
                        [results]="datosDiurnoFondos" [labels]="showLabels" [labelFormatting]="setLabelFormatting"
                        [legend]="showLegend" [legendPosition]="legendPosition" [legendTitle]="legendTitle"
                        (select)="mostrarDetalleEjecuciones($event, 'diurnos', 'fondos')">
                    </ngx-charts-pie-chart>
                </div>
            </div>
            <div class="row col-12 maxLeng2x" *ngIf="detalleDiurno">
                <div class="justify-content-center titulo-filtro">
                    {{ tituloGrafico }}
                </div>
                <ngx-charts-bar-vertical scheme="air" [results]="datosDetalleDiurno" [xAxis]="showXAxis"
                    [legendTitle]="legendTitle" [yAxis]="showYAxis" [legend]="showLegend"
                    [showXAxisLabel]="showXAxisLabel" [showDataLabel]="showDataLabel" [showYAxisLabel]="showYAxisLabel"
                    [xAxisLabel]="xAxisLabelProcesos" [yAxisLabel]="xAxisLabel">
                </ngx-charts-bar-vertical>
            </div>
        </div>
    </div>

    <!-- ************************************** -->
    <!-- ************************************** -->
    <!-- ********* N O C T U R N O S ********** -->
    <!-- ************************************** -->
    <!-- ************************************** -->
    <div class="card-busqueda" *ngIf="datosNocturno">
        <div class="row col-12 alert alert-primary justify-content-center">
            <div class="row">
                <div class="col-4 titulo-filtro"></div>
                <div class="col-4 titulo-filtro justify-content-center">Nocturnos &nbsp;
                    <i class="far fa-question-circle" (mouseenter)="helperQuestions('NOCTURNOS')"
                        triggers="mouseenter:mouseleave" [ngbPopover]="popContent"></i>
                </div>
                <div class="col-4 titulo-filtro justify-content-end">
                    <a class="limpiarFiltro" (click)="accionMinimizarNocturno()">
                        <img src="assets/icons/arrows-angle-contract.svg" class="tamanioIcono"
                            *ngIf="flagMinimizarNocturno == true" />
                        <img src="assets/icons/arrows-angle-expand.svg" class="tamanioIcono"
                            *ngIf="flagMinimizarNocturno == false" />
                    </a>
                </div>
            </div>
        </div>
        <div class="row col-12" *ngIf="flagMinimizarNocturno">
            <div class="row col-12">
                <div class="mh-25 d-inline-block col-sm-6 col-md-5 col-lg-6 justify-content-center">
                    <ngx-charts-bar-horizontal scheme="air" [results]="datosAforeFondos" [xAxis]="showXAxis"
                        [yAxis]="showYAxis" [legend]="showLegend" [legendTitle]="legendTitle"
                        [legendPosition]="legendPosition" [showXAxisLabel]="showXAxisLabel"
                        [showYAxisLabel]="showYAxisLabel" [xAxisLabel]="xAxisLabel" [showDataLabel]="showDataLabel"
                        [yAxisLabel]="yAxisLabelNegocio">
                    </ngx-charts-bar-horizontal>
                </div>
                <div
                    class="mh-25 d-inline-block col-sm-6 col-md-5 offset-md-2 col-lg-6 offset-lg-0 justify-content-center">
                    <ngx-charts-bar-horizontal scheme="air" [results]="datosLanzamiento" [xAxis]="showXAxis"
                        [yAxis]="showYAxis" [legend]="showLegend" [legendTitle]="legendTitle"
                        [legendPosition]="legendPosition" [showXAxisLabel]="showXAxisLabel"
                        [showYAxisLabel]="showYAxisLabel" [xAxisLabel]="xAxisLabel" [showDataLabel]="showDataLabel"
                        [yAxisLabel]="yAxisLabel">
                    </ngx-charts-bar-horizontal>
                </div>
                <div class="w-100"></div>
                <div class="col-sm-6 col-md-5 col-lg-6 justify-content-center">
                    <h4>
                        <span class="badge badge-pill badge-primary">AFORE &nbsp;
                            <i class="far fa-question-circle" (mouseenter)="helperQuestions('DETALLE')"
                                triggers="mouseenter:mouseleave" [ngbPopover]="popContent"></i>
                        </span>
                    </h4>
                </div>
                <div class="col-sm-6 col-md-5 offset-md-2 col-lg-6 offset-lg-0 justify-content-center">
                    <h4>
                        <span class="badge badge-pill badge-primary">FONDOS &nbsp;
                            <i class="far fa-question-circle" (mouseenter)="helperQuestions('DETALLE')"
                                triggers="mouseenter:mouseleave" [ngbPopover]="popContent"></i>
                        </span>
                    </h4>
                </div>
                <div class="w-100"></div>
                <div class="col-sm-6 col-md-5 col-lg-6 justify-content-center">
                    <ngx-charts-pie-chart [explodeSlices]="explodeSlices" [scheme]="colorScheme"
                        [results]="datosNocturnoAfore" [labels]="showLabels" [labelFormatting]="setLabelFormatting"
                        [legend]="showLegend" [legendPosition]="legendPosition" [legendTitle]="legendTitle"
                        (select)="mostrarDetalleEjecuciones($event, 'nocturnos', 'afore')">
                    </ngx-charts-pie-chart>
                </div>
                <div class="col-sm-6 col-md-5 offset-md-2 col-lg-6 offset-lg-0 justify-content-center">
                    <ngx-charts-pie-chart [explodeSlices]="explodeSlices" [scheme]="colorScheme"
                        [results]="datosNocturnoFondos" [labels]="showLabels" [labelFormatting]="setLabelFormatting"
                        [legend]="showLegend" [legendPosition]="legendPosition" [legendTitle]="legendTitle"
                        (select)="mostrarDetalleEjecuciones($event, 'nocturnos', 'fondos')">
                    </ngx-charts-pie-chart>
                </div>
            </div>
            <div class="row col-12 maxLeng2x" *ngIf="detalleNocturno">
                <div class="justify-content-center titulo-filtro">
                    {{ tituloGraficoNocturno }}
                </div>
                <ngx-charts-bar-vertical scheme="air" [results]="datosDetalleNocturno" [xAxis]="showXAxis"
                    [legendTitle]="legendTitle" [yAxis]="showYAxis" [legend]="showLegend"
                    [showXAxisLabel]="showXAxisLabel" [showDataLabel]="showDataLabel" [showYAxisLabel]="showYAxisLabel"
                    [xAxisLabel]="xAxisLabelProcesos" [yAxisLabel]="xAxisLabel">
                </ngx-charts-bar-vertical>
            </div>
        </div>
    </div>
</section>


<!-- ************************************** -->
<!-- ************************************** -->
<!-- ********* P R O B L E M A S ********** -->
<!-- ************************************** -->
<!-- ************************************** -->
<section name="interfases" *ngIf="botonActivado('PROBLEMAS')">
    <div class="d-flex col-md-12 col-sm-12 col-xs-12 col-lg-12 col-xl-12 justify-content-center"
        *ngIf="listadoProblemas">
        <div class="row justify-content-center" *ngIf="listadoProblemas.length === 0">
            <div class=" align-self-center">
                <div class="d-flex flex-column" style="width: 504px;">
                    <div class="descripcionNoAuditoria" style="margin-top:34px">
                        <div class="row">
                            <div class="col-12">
                                <p> No existen registros para esta búsqueda.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-lista-design-general" style="overflow-x: auto" *ngIf="listadoProblemas.length !== 0">
            <table class="table listado-design-general">
                <tr>
                    <th style="padding-left: 40px; max-width: 250px">Fecha</th>
                    <th style="padding-left: 30px; max-width: 300px">Proceso</th>
                    <th style="padding-left: 30px; max-width: 150px">Responsable</th>
                    <th style="padding-left: 30px; max-width: 350px">Problema</th>
                </tr>
                <tr *ngFor="let item of listadoProblemas | paginate : {
                    id: 'auditoria',
                    itemsPerPage: 10,
                    currentPage: paginaActual
                  };
            index as i
          ">
                    <td style="padding-left: 40px; max-width: 250px"> {{item.fecha | date :'dd/MM/yyyy'}}
                        {{item.fecha | date:'mediumTime'}}
                    </td>
                    <td style="padding-left: 30px; max-width: 300px">{{item.proceso}}
                    </td>
                    <td style="padding-left: 30px; max-width: 150px">{{item.responsable}}
                    </td>
                    <td style="padding-left: 30px; max-width: 150px" *ngIf="!flagSoporte">{{item.mensaje_negocio}}
                    </td>
                    <td style="padding-left: 30px; max-width: 350px" *ngIf="flagSoporte">{{item.mensaje_soporte}}
                    </td>
                </tr>
            </table>
            <div class="paginator align-items-left"></div>
            <pagination-template id="auditoria" #p="paginationApi" (pageChange)="paginaActual = $event"
                class="ngx-pagination">
                <div class="custom-pagination">
                    <div class="pagination-previous" [class.disabled]="p.isFirstPage()">
                        <span *ngIf="!p.isFirstPage()" (click)="p.previous()">
                            << </span>
                    </div>
                    <div class="page-number" *ngFor="let page of p.pages"
                        [class.current]="p.getCurrent() === page.value">
                        <span (click)="p.setCurrent(page.value)" *ngIf="p.getCurrent() !== page.value">{{ page.label
                            }}</span>
                        <div *ngIf="p.getCurrent() === page.value">
                            <span>{{ page.label }}</span>
                        </div>
                    </div>
                    <div class="pagination-next" [class.disabled]="p.isLastPage()">
                        <span *ngIf="!p.isLastPage()" (click)="p.next()"> >> </span>
                    </div>
                </div>
            </pagination-template>
        </div>
    </div>
</section>

<!--
<div class="row card-base-grafico">
    <div class="col-sm-6 col-md-5 col-lg-6">
        <div class="card-grafico">
            Resumen de interfases
        </div>
    </div>
    <div class="col-sm-6 col-md-5 offset-md-2 col-lg-6 offset-lg-0">
        <div class="card-grafico">
            Resumen de lanzamientos
        </div>
    </div>
</div>
-->

<ng-template #popContent>
    <div class="texto-help" style="width: 100%"> {{ helpBody }}</div>
</ng-template>
<ng-template #popTitle> {{ helpTitulo }} </ng-template>

<ng-template #modalEstado let-modal id="modalFiltro">
    <div class="modal-body">
        <div class="row justify-content-center">
            <div class="col-12 row justify-content-center align-items-center" style="height:120px;">
                <div class="textoConfirmacionModalUsuarios">Aplicar filtro</div>
            </div>
            <div class="col-12 row">
                <div class="col-12 descripcionConfirmacionEjecucionProceso">
                    {{ mensajeError }} 
                </div>
            </div>
            <div class="col-12 row justify-content-center align-items-center" style="height:120px;">
                <div>
                    <button class="button" (click)="cerrarModales()">Aceptar</button>
                </div>
            </div>
        </div>
    </div>
</ng-template>